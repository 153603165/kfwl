<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />
</head>
<body>
<div th:replace="include/include::html"></div>
<iframe id="download_temp_iframe" style="display: none;"></iframe>

   <div data-options="region:'north',title:'报表导出',collapsed:false,split:false,border:false"
    style="padding: 0px; height: auto; width: 100%; overflow-y: hidden;">
        <form id="preBillingRecordExport_search_form" style="padding: 2px;">
			日期：
            <input id="startTime"  name="startTime" class="easyui-my97" data-options="dateFmt:'yyyy/MM'" />
            	-
            <input id="endTime"  name="endTime" class="easyui-my97" data-options="dateFmt:'yyyy/MM'" />
			法人:
            <input type="text" name="legalPerson" class="easyui-textbox" id="legalPerson" data-options="width:120,prompt:'按法人名称搜索'" />
			所属公司:
            <input type="text" name="companyName" class="easyui-textbox" id="companyName" data-options="width:200,prompt:'按所属公司搜索'"/>
                                           类别:
			<input id="category" name="category"  panelHeight="auto" class="easyui-combobox" data-options="width:120,prompt:'请选择类别'"/>
            <a href="#" class="easyui-linkbutton" iconCls="icon-search" onClick="loadData();">查询</a> 
            <a href="#" class="easyui-linkbutton" iconCls="icon-search" onClick="downloadFile();">导出</a>
			<a href="#" class="easyui-linkbutton" iconCls="icon-clear" onClick="billingRecordExport_clear();">清空</a>
        </form>
    </div>
    	<!-- 中间部分 列表 -->	
    <div data-options="region:'center'" style="padding: 0px; height: 570px; width: 100%; overflow-y: hidden;">
	    <table id="preBillingRecordExport_datagrid"  style="width: auto;">
	    </table>
    </div>
</body>
<script type="text/JavaScript" th:inline="javascript">
/*<![CDATA[*/
    var preBillingRecordExport_search_form;
    $(document).ready(function(){
    	//初始化下拉数据
    	$('#category').combobox({
   	        url:"/preBillingRecord/categoryCombobox",
   	        multiple:false,//是否可多选
   	        editable:false,//是否可编辑
   	        width:120,
   	        method:'get',
   	     	valueField:"id",
   	     	textField:"text"
   	    });
        preBillingRecordExport_search_form = $('#preBillingRecordExport_search_form').form();
    });
    function loadData(){
    	var startTime=$("#startTime").val();
		var endTime=$("#endTime").val();
		var category=$("#category").combobox('getValue');;
		var companyName=$("#companyName").textbox('getValue');
		var legalPerson=$("#legalPerson").textbox('getValue');
		if(startTime==''||endTime==''){
			eu.showMsg("请完整填写年月");
			return false;
		}
		if(startTime>endTime){
			eu.showMsg("月份开始时间不能超过结束时间");
			return false;
		}
		$.getJSON('/preBillingRecord/preBillingRecordExportTitle',
				{"startTime":startTime,"endTime":endTime,"category":category,"companyName":companyName,"legalPerson":legalPerson},function(data){
			writeTable(data,startTime,endTime,category,companyName,legalPerson);
		});  
    }
    //数据列表
    function writeTable(data,startTime,endTime,category,companyName,legalPerson){
       	$('#preBillingRecordExport_datagrid').datagrid({
            url: '/preBillingRecord/exportPreBillingRecordDatagrId',
            queryParams: {          
                'startTime': startTime,
                'endTime': endTime,
                'category': category,
                'companyName': companyName,
                'legalPerson': legalPerson,
            },  
            fit:true,
            pagination: false,//底部分页
            pagePosition: 'bottom',//'top','bottom','both'.
            fitColumns: false,//自适应列宽
            striped: true,//显示条纹
            //pageSize: 20,//每页记录数
            singleSelect: false,//单选模式
            rownumbers: true,//显示行数
            method:'get',
            checkbox: true,
            nowrap: false,
            border: false,
            remoteSort: true,//是否通过远程服务器对数据排序
            sortName: 'id',//默认排序字段
            sortOrder: 'asc',//默认排序方式 'desc' 'asc'
            idField: 'id',
            frozenColumns:[data.thsfix],
            columns: [data.ths],
            onLoadSuccess:function(data){
		    	$(this).datagrid('clearSelections');//取消所有的已选择项
		    	$(this).datagrid('unselectAll');//取消全选按钮为全选状态
			},
            onRowContextMenu: function (e, rowIndex, rowData) {
                e.preventDefault();
                $(this).datagrid('unselectAll');
                $(this).datagrid('selectRow', rowIndex);
            } 
        }).datagrid("showTooltip");
     	// 表头居中
        eu.datagridHeaderCenter();
	} 
    
  	// 清空
  	function billingRecordExport_clear() {
  		preBillingRecordExport_search_form.form("clear");
  	}
  	//下载
	function downloadFile() {
		var startTime=$("#startTime").val();
		var endTime=$("#endTime").val();
		var category=$("#category").combobox('getValue');;
		var companyName=$("#companyName").textbox('getValue');
		var legalPerson=$("#legalPerson").textbox('getValue');
		if(startTime==''||endTime==''){
			eu.showMsg("请完整填写年月");
			return false;
		}
		if(startTime>endTime){
			eu.showMsg("月份开始时间不能超过结束时间");
			return false;
		}
		$('#download_temp_iframe').attr('src','/preBillingRecord/exportPreBillingRecordExcel?startTime='+startTime+'&endTime='+endTime+'&companyName='+encodeURI(encodeURI(companyName))+'&category='+encodeURI(encodeURI(category))+'&legalPerson='+encodeURI(encodeURI(legalPerson)));
	}
  //弹出加载层
    function load() {  
        $("<div class=\"datagrid-mask\"></div>").css({ display: "block", width: "100%", height: $(window).height() }).appendTo("body");  
        $("<div class=\"datagrid-mask-msg\"></div>").html("正在上传，请稍候。。。").appendTo("body").css({ display: "block", left: ($(document.body).outerWidth(true) - 190) / 2, top: ($(window).height() - 45) / 2 });  
    }  
      
    //取消加载层  
    function disLoad() {  
        $(".datagrid-mask").remove();  
        $(".datagrid-mask-msg").remove();  
    }
	/*]]>*/
</script>
</html>